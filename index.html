<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>ãƒ¢ãƒ³ãƒãƒ³Now ã‚¹ã‚­ãƒ«ã‚·ãƒ¥ãƒŸãƒ¬ãƒ¼ã‚¿ãƒ¼</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --bg:#0d0d0d; --panel:#171717; --card:#1f1f1f;
    --text:#ffffff; --muted:#bfbfbf; --accent:#ffd45e; --accent2:#ffb347; --border:#2a2a2a;
    --hilite:#ffe27a; --skill:#e6e6e6; --drift:#a7dcff;
    --green:#2ecc71; --purple:#bb86fc; --off:#555; --blue:#4da3ff;
  }
  *{box-sizing:border-box}
  body{
    margin:0; background:var(--bg); color:var(--text);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;
    height:100vh; display:grid; grid-template-columns:460px 1fr;
  }
  /* å·¦ãƒ‘ãƒãƒ« */
  .left{
    background:var(--panel); border-right:1px solid var(--border);
    padding:18px; overflow:auto;
  }
  .title{color:var(--accent); font-size:20px; font-weight:700; margin-bottom:12px}
  .tabs{display:flex; gap:8px; margin-bottom:14px; flex-wrap:wrap}
  .tab{
    padding:8px 12px; border:1px solid var(--border); border-radius:10px;
    background:#101010; color:#ddd; cursor:pointer; font-weight:700; font-size:14px;
  }
  .tab.active{background:var(--accent); color:#111; border-color:#cdbf65}

  .group{margin-bottom:16px}
  label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
  input, select, button{
    width:100%; border:1px solid var(--border); background:#101010; color:#fff;
    border-radius:8px; padding:9px 10px; font-size:14px;
  }
  input:disabled{opacity:.55; cursor:not-allowed}
  button{background:var(--accent); color:#111; border:none; font-weight:700; cursor:pointer}
  button:hover{filter:brightness(1.05)}
  .rows{display:grid; grid-template-columns:1fr 84px; gap:8px}
  .status{font-size:12px; color:var(--muted); white-space:pre-line; margin-top:6px}

  /* ==== ä¸¸ãƒãƒ–é¢¨ãƒˆã‚°ãƒ« ==== */
  .toggles { display:flex; align-items:center; gap:16px; margin-bottom:10px; }
  .toggle-block { display:flex; align-items:center; gap:8px; }
  .dot {
    width:42px; height:22px; border-radius:999px; background:var(--off);
    border:2px solid var(--border); position:relative; cursor:pointer;
    transition:background .25s, border-color .25s;
  }
  .dot::before{
    content:""; position:absolute; top:2px; left:2px; width:16px; height:16px;
    background:#ccc; border-radius:50%; transition:left .25s, background .25s;
  }
  .dot.green.on{background:var(--green); border-color:var(--green)}
  .dot.green.on::before{left:22px; background:#fff}
  .dot.purple.on{background:var(--purple); border-color:var(--purple)}
  .dot.purple.on::before{left:22px; background:#fff}
  .dot.blue.on{background:var(--blue); border-color:var(--blue)}
  .dot.blue.on::before{left:22px; background:#fff}
  .dot.off{background:var(--off); border-color:var(--border)}
  .dot.off::before{left:2px; background:#888}
  .hint{font-size:12px; color:var(--muted); margin-top:2px}

  /* å³ãƒ‘ãƒãƒ«ï¼‹ã‚«ãƒ¼ãƒ‰ */
  .right{padding:18px; overflow:auto}
  .grid{display:grid; grid-template-columns:repeat(auto-fill, minmax(420px,1fr)); gap:16px}
  .card{
    background:var(--card); border:1px solid var(--border); border-radius:12px; padding:12px 14px;
    box-shadow:0 0 10px rgba(0,0,0,0.35);
  }
  .card h3{margin:0 0 8px 0; color:var(--accent2); font-size:16px}
  .equip{white-space:pre-wrap; line-height:1.5; color:#eaeaea; margin:0 0 8px 0}
  .hr{height:1px; background:var(--border); margin:8px 0}
  .sumAll{display:flex; flex-wrap:wrap; gap:8px 12px; margin:0; padding:0}
  .badge{
    list-style:none; border:1px solid var(--border); border-radius:999px;
    padding:2px 8px; font-size:12px; color:var(--skill); background:#141414; white-space:nowrap;
  }
  .badge.hilite{color:#111; background:var(--hilite); border-color:#cdbf65}
  .drifts{color:var(--drift); font-size:12px; margin-top:6px}

  /* å³ä¸Šå›ºå®šã®é€²æ—è¡¨ç¤º */
  .progressFloating{
    position:fixed; top:12px; right:16px; background:#000a; backdrop-filter:blur(4px);
    border:1px solid var(--border); border-radius:10px; padding:8px 12px; font-size:12px;
    color:var(--muted); z-index:9999; pointer-events:none;
  }

  /* ä¸€è¦§ã‚¿ãƒ–ã®ãƒ†ãƒ¼ãƒ–ãƒ« */
  .list-controls{display:flex; gap:8px; position:sticky; top:0; background:var(--panel); padding-bottom:8px; z-index:2; align-items:center}
  .tableWrap{border:1px solid var(--border); border-radius:12px; overflow:auto; max-height:calc(100vh - 120px)}
  table{width:100%; border-collapse:collapse; font-size:13px}
  thead{background:#141414; z-index:1}
  th, td{border-bottom:1px solid var(--border); padding:8px 10px; vertical-align:top}
  th{color:#ddd; text-align:left}
  td{color:#eee}
  .td-skills{color:#ddd}
  .muted{color:#aaa; font-size:12px}
  .sticky-header thead th{ position:sticky; top:0; background:#141414; }

  /* éŒ¬æˆCSVä½œæˆã‚¿ãƒ– */
  .maker-ops{display:flex; gap:8px; flex-wrap:wrap}
  .maker-note{color:var(--muted); font-size:12px; margin-top:6px}
  .makerWrap{border:1px solid var(--border); border-radius:12px; overflow:auto; max-height:calc(100vh - 200px)}
  .makerTable input, .makerTable select{ width:100%; padding:6px 8px; font-size:13px }
  .btnDanger{ background:#e45858; color:#fff }

  /* ===== ã‚¹ãƒãƒ›ï¼šæ¤œç´¢çµæœã‚’ãƒœã‚¿ãƒ³ä¸‹ã«ã€ä¸€è¦§ã¯ã‚«ãƒ¼ãƒ‰åŒ– ===== */
  @media (max-width: 640px) {
    body{ grid-template-columns:1fr; height:auto }
    .right{ order:3 }
    .tableWrap{ border:none; overflow:visible; max-height:none }
    table.sticky-header, table.sticky-header thead, table.sticky-header tbody,
    table.sticky-header th, table.sticky-header td, table.sticky-header tr{
      display:block; width:100%;
    }
    table.sticky-header thead{ display:none }
    table.sticky-header tr{
      margin-bottom:14px; border:1px solid var(--border); border-radius:10px;
      background:var(--card); box-shadow:0 0 8px rgba(0,0,0,0.25); padding:10px;
    }
    table.sticky-header td{
      border:none; padding:4px 0; font-size:13px; display:flex; justify-content:space-between; gap:8px;
    }
    table.sticky-header td::before{ content:attr(data-label); color:var(--muted); font-weight:bold }
    .makerWrap{ max-height:none; border:none }
  }
</style>
</head>
<body>
  <aside class="left">
    <div class="title">ãƒ¢ãƒ³ãƒãƒ³Now ã‚¹ã‚­ãƒ«ã‚·ãƒ¥ãƒŸãƒ¬ãƒ¼ã‚¿ãƒ¼</div>

    <!-- ã‚¿ãƒ– -->
    <div class="tabs">
      <button class="tab active" id="tab-sim">ã‚¹ã‚­ãƒ«ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</button>
      <button class="tab" id="tab-list">é˜²å…·ã‚¹ã‚­ãƒ«ä¸€è¦§</button>
      <button class="tab" id="tab-maker">éŒ¬æˆCSVä½œæˆ</button>
    </div>

    <!-- CSVèª­ã¿è¾¼ã¿ -->
    <div class="group">
      <label>CSVã‚’èª­ã¿è¾¼ã‚€ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼å¿…é ˆ / UTF-8ï¼‰</label>
      <input type="file" id="csv" accept=".csv" />
      <div id="status" class="status">æœªèª­è¾¼</div>
    </div>

    <!-- ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼è¨­å®š -->
    <div class="group" id="panel-sim">
      <div class="toggles">
        <div class="toggle-block">
          <div class="dot green off" id="toggleRock" title="ãƒ­ãƒƒã‚¯ã‚ªãƒ³ ON/OFF" aria-label="ãƒ­ãƒƒã‚¯ã‚ªãƒ³"></div>
          <span class="hint">ãƒ­ãƒƒã‚¯ã‚ªãƒ³</span>
        </div>
        <div class="toggle-block">
          <div class="dot purple off" id="toggleDrift" title="æ¼‚ç§»éŒ¬æˆ ON/OFF" aria-label="æ¼‚ç§»éŒ¬æˆ"></div>
          <span class="hint">æ¼‚ç§»éŒ¬æˆ</span>
        </div>
      </div>

      <label>ã‚¹ã‚­ãƒ«æ¡ä»¶ï¼ˆæœ€å¤§8å€‹ï¼‰ â€»Lv1ã€œ5ï¼Lvç©ºæ¬„ã¯æ¡ä»¶ã‹ã‚‰é™¤å¤–</label>
      <div class="rows" id="rows"></div>

      <div class="group" style="margin-top:10px">
        <button id="search">æ¤œç´¢</button>
        <button id="reset" style="margin-top:6px; background:#555; color:#fff;">ãƒªã‚»ãƒƒãƒˆ</button>
        <div id="progress" class="status"></div>
      </div>
    </div>

    <!-- ä¸€è¦§ã‚¿ãƒ–ã®æ“ä½œ -->
    <div id="panel-list" style="display:none;">
      <div class="group">
        <label>ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</label>
        <div class="list-controls">
          <select id="flt-part">
            <option value="">éƒ¨ä½ï¼šã™ã¹ã¦</option>
            <option>é ­</option><option>èƒ´</option><option>è…•</option><option>è…°</option><option>è„š</option>
          </select>
          <input id="flt-skill" placeholder="ã‚¹ã‚­ãƒ«åã§æ¤œç´¢ï¼ˆéƒ¨åˆ†ä¸€è‡´ï¼é€šå¸¸ãƒ»éŒ¬æˆï¼‰" />
        </div>
        <div class="toggle-block" title="éŒ¬æˆã‚¹ã‚­ãƒ«ã ã‘è¡¨ç¤º" style="margin-top:10px;">
          <div class="dot blue off" id="toggleListDrift" aria-label="éŒ¬æˆãƒ•ã‚£ãƒ«ã‚¿"></div>
          <span class="hint">éŒ¬æˆã®ã¿</span>
        </div>
      </div>
    </div>
  
  </aside>

  <main class="right">
    <!-- ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿çµæœ -->
    <div id="resultsSim" class="grid"></div>

    <!-- ä¸€è¦§ è¡¨ -->
    <div id="resultsList" style="display:none;">
      <div class="tableWrap">
        <table id="armorTable" class="sticky-header">
          <thead>
            <tr>
              <th style="width:60px;">éƒ¨ä½</th>
              <th style="width:170px;">ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼</th>
              <th style="width:200px;">é˜²å…·å</th>
              <th>é€šå¸¸ã‚¹ã‚­ãƒ«</th>
              <th>éŒ¬æˆã‚¹ã‚­ãƒ«</th>
            </tr>
          </thead>
          <tbody id="listBody"></tbody>
        </table>
      </div>
      <div class="muted" id="listCount" style="margin-top:6px;"></div>
    </div>
  

  <!-- éŒ¬æˆCSVä½œæˆ è¡¨ -->
<div id="panel-maker" style="display:none;">
  <div class="maker-ops" style="margin-bottom:10px;">
    <button id="makerAdd">ï¼‹è¡Œè¿½åŠ </button>
    <button id="makerDownload">CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
    <button id="makerApply">ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã¸åæ˜ </button>
  </div>
  <div class="maker-note">â€»ã€ŒéŒ¬æˆã‚¹ã‚­ãƒ«ã€ã¯1è¡Œã‚ãŸã‚Šæœ€å¤§5ã¤ã€‚ç©ºæ¬„ã¯ç„¡è¦–ã•ã‚Œã‚‹ã‚ˆã€‚</div>
  <div class="makerWrap" style="margin-top:10px;">
    <table class="makerTable sticky-header" id="makerTable">
      <thead>
        <tr>
          <th style="width:80px;">éƒ¨ä½</th>
          <th style="width:160px;">ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼</th>
          <th style="width:200px;">é˜²å…·å</th>
          <th>éŒ¬æˆ1</th><th>éŒ¬æˆ2</th><th>éŒ¬æˆ3</th><th>éŒ¬æˆ4</th><th>éŒ¬æˆ5</th>
          <th style="width:80px;">æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="makerBody"></tbody>
    </table>
  </div>
</div>
</main>

  <!-- å³ä¸Šå›ºå®šã®é€²æ—ï¼… -->
  <div id="progressFloating" class="progressFloating" style="display:none;">æ¢ç´¢å¾…æ©Ÿä¸­â€¦</div>

<script>
/* ====== ãƒ‡ãƒ¼ã‚¿æ§‹é€  ====== */
const PARTS = ["é ­","èƒ´","è…•","è…°","è„š"];
let armors = []; // {part, monster, name, normal:[{name,lv}], drift:[string]}
let skillSet = new Set();

/* ====== ãƒˆã‚°ãƒ«çŠ¶æ…‹ ====== */
let rockOnEnabled = false; // ãƒ­ãƒƒã‚¯ã‚ªãƒ³ï¼ˆç·‘ï¼‰
let driftEnabled  = false; // æ¼‚ç§»éŒ¬æˆï¼ˆç´«ï¼‰
let listDriftOnly = false; // ä¸€è¦§ã‚¿ãƒ– éŒ¬æˆã®ã¿

/* ====== è¦ç´ å‚ç…§ ====== */
const statusEl = document.getElementById('status');
const resultsSim = document.getElementById('resultsSim');
const resultsList = document.getElementById('resultsList');
const panelSim = document.getElementById('panel-sim');
const panelList = document.getElementById('panel-list');
const panelMaker = document.getElementById('panel-maker');
const tabSim = document.getElementById('tab-sim');
const tabList = document.getElementById('tab-list');
const tabMaker = document.getElementById('tab-maker');

/* ====== ã‚¿ãƒ–åˆ‡æ›¿ ====== */
function showTab(which){
  // tabs active
  [tabSim, tabList, tabMaker].forEach(b=>b.classList.remove('active'));
  if(which==='sim') tabSim.classList.add('active');
  if(which==='list') tabList.classList.add('active');
  if(which==='maker') tabMaker.classList.add('active');

  // panels
  panelSim.style.display = (which==='sim')?'block':'none';
  panelList.style.display = (which==='list')?'block':'none';
  panelMaker.style.display= (which==='maker')?'block':'none';

  // right side content
  resultsSim.style.display  = (which==='sim')?'grid':'none';
  resultsList.style.display = (which==='list')?'block':'none';

  // mobile: æ¤œç´¢çµæœä½ç½®ã‚’èª¿æ•´
  adjustLayoutForMobile();
}
tabSim.addEventListener('click', ()=>showTab('sim'));
tabList.addEventListener('click', ()=>showTab('list'));
tabMaker.addEventListener('click', ()=>showTab('maker'));

/* ====== ãƒˆã‚°ãƒ«æ“ä½œ ====== */
const toggleRock  = document.getElementById('toggleRock');
const toggleDrift = document.getElementById('toggleDrift');
const toggleListDrift = document.getElementById('toggleListDrift');

toggleRock.addEventListener('click', ()=>{
  rockOnEnabled = !rockOnEnabled;
  toggleRock.classList.toggle('on', rockOnEnabled);
  toggleRock.classList.toggle('off', !rockOnEnabled);
});
toggleDrift.addEventListener('click', ()=>{
  driftEnabled = !driftEnabled;
  toggleDrift.classList.toggle('on', driftEnabled);
  toggleDrift.classList.toggle('off', !driftEnabled);
});
toggleListDrift?.addEventListener('click', ()=>{
  listDriftOnly = !listDriftOnly;
  toggleListDrift.classList.toggle('on', listDriftOnly);
  toggleListDrift.classList.toggle('off', !listDriftOnly);
  buildListTable(); // å†æç”»
});

/* ====== CSVã‚’ãƒšãƒ¼ã‚¸ä¸Šã§èª­ã¿è¾¼ã‚€ ====== */
document.getElementById('csv').addEventListener('change', (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const reader = new FileReader();
  reader.onload = ev => {
    try{
      parseCSV(ev.target.result);
      statusEl.textContent = `CSVèª­ã¿è¾¼ã¿å®Œäº†ï¼š${armors.length}ä»¶ï¼ˆã‚¹ã‚­ãƒ«å€™è£œ ${skillSet.size}ï¼‰`;
      // å–ã‚Šè¾¼ã‚“ã éŒ¬æˆã‚’ãƒ¡ãƒ¼ã‚«ãƒ¼ã«ã‚‚åæ˜ 
      populateMakerFromArmors();
    }catch(err){
      console.error(err);
      statusEl.textContent = "CSVè§£æã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
    }
  };
  reader.readAsText(f, 'utf-8');
});

/* ====== CSVè§£æ ====== */
function parseCSV(text){
  const lines = text.replace(/\r\n/g,"\n").replace(/\r/g,"\n").split("\n").filter(Boolean);
  const rows = lines.map(line => splitCsvLine(line));
  armors = []; skillSet = new Set();

  // ãƒ˜ãƒƒãƒ€ãƒ¼å‰æ
  for(let i=1;i<rows.length;i++){
    const r = rows[i];
    if(r.length<3) continue;
    const part = r[0], monster = r[1], name = r[2];
    if(!part || !name) continue;

    const normal = [];
    for(let k=0;k<3;k++){
      const s  = r[3 + k*2];
      const lv = parseInt(r[4 + k*2],10);
      if(s && !isNaN(lv) && lv>0){
        normal.push({name:s, lv});
        skillSet.add(s);
      }
    }
    const drift = [];
    for(let j=0;j<10;j++){
      const ds = r[9 + j];
      if(ds){
        drift.push(ds);
        skillSet.add(ds);
      }
    }
    armors.push({part, monster, name, normal, drift});
  }

  buildSkillInputs([...skillSet].sort());
  buildListTable(); // ä¸€è¦§ã‚¿ãƒ–åˆæœŸæç”»
}

/* ====== CSV 1è¡Œãƒ‘ãƒ¼ã‚µï¼ˆç°¡æ˜“, ã‚«ãƒ³ãƒ+ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆå¯¾å¿œï¼‰ ====== */
function splitCsvLine(line){
  const out=[]; let cur=""; let inQ=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i];
    if(ch==='"' ){
      if(inQ && line[i+1]==='"'){ cur+='"'; i++; }
      else inQ=!inQ;
    }else if(ch===',' && !inQ){
      out.push(cur.trim()); cur="";
    }else{
      cur+=ch;
    }
  }
  out.push(cur.trim());
  return out;
}

/* ====== ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿å…¥åŠ›UIï¼ˆ8æ ã€Lvã¯ã‚¹ã‚­ãƒ«åãŒç©ºãªã‚‰ç„¡åŠ¹ï¼‰ ====== */
function buildSkillInputs(skillList){
  const rows = document.getElementById('rows');
  rows.innerHTML = "";
  const dlId="skills";
  let old = document.getElementById(dlId); if(old) old.remove();
  const dl = document.createElement('datalist'); dl.id = dlId;
  skillList.forEach(s=>{ const o=document.createElement('option'); o.value=s; dl.appendChild(o); });
  document.body.appendChild(dl);

  for(let i=0;i<8;i++){
    const name = document.createElement('input');
    name.type="text"; name.placeholder="ã‚¹ã‚­ãƒ«å"; name.setAttribute("list", dlId); name.id=`s_${i}`;
    const lv = document.createElement('input');
    lv.type="number"; lv.min="1"; lv.max="5"; lv.placeholder="Lv"; lv.id=`lv_${i}`;
    lv.disabled = true;

    const syncDisable = ()=>{
      const has = (name.value || "").trim().length > 0;
      lv.disabled = !has;
      if(!has) lv.value = "";
    };
    name.addEventListener('input', syncDisable);
    name.addEventListener('change', syncDisable);

    rows.appendChild(name); rows.appendChild(lv);
  }

  // ã‚¯ãƒªãƒƒã‚¯äºŒé‡ç™»éŒ²ã‚’é¿ã‘ã‚‹ãŸã‚ç½®æ›
  const newBtn = document.getElementById('search').cloneNode(true);
  document.getElementById('search').replaceWith(newBtn);
  newBtn.id = 'search';
  newBtn.addEventListener('click', runSearch);
}

/* ====== ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ ====== */
document.getElementById('reset').addEventListener('click', ()=>{
  for(let i=0;i<8;i++){
    const sEl = document.getElementById(`s_${i}`);
    const lEl = document.getElementById(`lv_${i}`);
    if(sEl) sEl.value = "";
    if(lEl){ lEl.value = ""; lEl.disabled = true; }
  }
  document.getElementById('progress').textContent = "";
  document.getElementById('resultsSim').innerHTML = "";
});

/* ====== æ¤œç´¢æœ¬ä½“ ====== */
function runSearch(){
  const resultsBox = resultsSim;
  const progressEl = document.getElementById('progress');
  const floatEl = document.getElementById('progressFloating');
  resultsBox.innerHTML = "";
  progressEl.textContent = "";

  const shownCombos = new Set();
  if (armors.length === 0) {
    resultsBox.innerHTML = cardHTML("ãƒ‡ãƒ¼ã‚¿æœªèª­è¾¼", "CSVã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚");
    return;
  }

  // æ¡ä»¶å–å¾—
  const conds = [];
  for (let i = 0; i < 8; i++) {
    const s = (document.getElementById(`s_${i}`)?.value || "").trim();
    const lv = parseInt(document.getElementById(`lv_${i}`)?.value || "", 10);
    if (s && !isNaN(lv) && lv > 0) conds.push({ skill: s, level: lv });
  }
  if (rockOnEnabled && !conds.some(c => c.skill === "ãƒ­ãƒƒã‚¯ã‚ªãƒ³"))
    conds.push({ skill: "ãƒ­ãƒƒã‚¯ã‚ªãƒ³", level: 1 });

  if (conds.length === 0) {
    resultsBox.innerHTML = cardHTML("æ¡ä»¶ä¸è¶³", "ã‚¹ã‚­ãƒ«åã‚’å…¥åŠ›ã—ã¦ã­ã€‚");
    return;
  }

  // æ¡ä»¶ã‚¹ã‚­ãƒ«ã‚’å«ã‚€é˜²å…·ã ã‘æŠ½å‡ºï¼ˆç©ºãæ è¨±å®¹ã®ãŸã‚ null ã‚’å…¥ã‚Œã‚‹ï¼‰
  const byPart = { é ­: [], èƒ´: [], è…•: [], è…°: [], è„š: [] };
  for (const a of armors) {
    if (
      conds.some(c => a.normal.some(s => s.name === c.skill)) ||
      (driftEnabled && conds.some(c => a.drift.includes(c.skill)))
    ) {
      byPart[a.part].push(a);
    }
  }
  const activeParts = Object.entries(byPart).map(([p, v]) => [p, v.length>0 ? [...v, null] : [null]]);
  // ã‚½ãƒ¼ãƒˆï¼ˆnullå¯¾ç­–ï¼‰
  for (const [_, list] of activeParts) {
    list.sort((a, b) => {
      const getCondLv = (armor) => {
        if (!armor) return 0;
        return conds.reduce((sum, c) => {
          let n = armor.normal.find(s => s.name === c.skill)?.lv || 0;
          let d = (driftEnabled && armor.drift.includes(c.skill)) ? 1 : 0;
          return sum + n + d;
        }, 0);
      };
      return getCondLv(b) - getCondLv(a);
    });
  }

  function* generateCombos(parts, i = 0, current = {}) {
    if (i >= parts.length) { yield current; return; }
    const [p, items] = parts[i];
    for (const it of items) yield* generateCombos(parts, i + 1, { ...current, [p]: it });
  }

  const hits = [];
  let checked = 0;
  floatEl.style.display = "block";

  outer: for (const combo of generateCombos(activeParts)) {
    checked++;
    const totalMap = {};
    for (const p of PARTS) {
  const item = combo[p];
  if (!item) continue;

  // é€šå¸¸ã‚¹ã‚­ãƒ«ã®åŠ ç®—
  for (const { name, lv } of item.normal) {
    totalMap[name] = (totalMap[name] || 0) + lv;
  }

  // éŒ¬æˆã‚¹ã‚­ãƒ«ï¼ˆdriftï¼‰ã®å‡¦ç†
  if (driftEnabled && item.drift.length > 0) {
    // æ¤œç´¢æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹ã‚¹ã‚­ãƒ«ã ã‘ã‚’1ã¤é¸ã¶
    const matched = conds.find(c => item.drift.includes(c.skill));
    if (matched) {
      totalMap[matched.skill] = (totalMap[matched.skill] || 0) + 1;
    } else {
      // ä¸€è‡´ã—ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆãã®é˜²å…·ã®éŒ¬æˆã¯ç„¡åŠ¹ï¼‰
      continue;
    }
  }
}

    // ğŸ”¸ æ¡ä»¶ã‚¹ã‚­ãƒ«ã®Lvã‚’æº€ãŸã—ã¦ã„ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
let meetsAll = true;
for (const c of conds) {
  const haveLv = totalMap[c.skill] || 0;
  if (haveLv < c.level) {
    meetsAll = false;
    break;
  }
}
if (!meetsAll) continue;



    const comboKey = PARTS.map(p => combo[p]?.name || "").join("|");
    if (shownCombos.has(comboKey)) continue;
    shownCombos.add(comboKey);

    const text = PARTS.map(p => `${p}ï¼š${combo[p]?.name || ""}`).join("\n");

// ã‚¹ã‚­ãƒ«ãƒªã‚¹ãƒˆã‚’æ¡ä»¶ä¸€è‡´ã«åˆã‚ã›ã¦æ•´å½¢
const skills = Object.entries(totalMap)
  .filter(([n]) => {
    if (driftEnabled) {
      const isDriftSkill = armors.some(a => a.drift.includes(n));
      if (isDriftSkill && !conds.some(c => c.skill === n)) return false;
    }
    return true;
  })
  .sort((a, b) => b[1] - a[1])
  .map(([n, l]) => `<li class="badge${conds.some(c => c.skill === n) ? " hilite" : ""}">${n} Lv${l}</li>`)
  .join("");

// ğŸŸ£ ã“ã®ã‚³ãƒ³ãƒœã§å®Ÿéš›ã«åæ˜ ã•ã‚ŒãŸéŒ¬æˆã‚¹ã‚­ãƒ«ä¸€è¦§
let driftApplied = [];
if (driftEnabled) {
  for (const p of PARTS) {
    const item = combo[p];
    if (!item) continue;
    // æ¡ä»¶ã‚¹ã‚­ãƒ«ã«ä¸€è‡´ã—ãŸéŒ¬æˆã®ã¿è¡¨ç¤º
    const matched = conds.find(c => item.drift.includes(c.skill));
    if (matched) driftApplied.push(`${p}ï¼š${matched.skill}`);
  }
}

// ğŸ©µ éŒ¬æˆã‚¹ã‚­ãƒ«è¡¨ç¤ºã‚’æ•´å½¢ï¼ˆéƒ¨ä½åã¨ä¸€ç·’ã«ï¼‰
let driftText = "";
if (driftApplied.length) {
  const driftList = driftApplied
    .map(d => `<span class="badge" style="color:var(--drift);border-color:var(--drift);">${d.part}ï¼š${d.skill}</span>`)
    .join(" ");
  driftText = `<div class="drifts">æ¼‚ç§»éŒ¬æˆï¼š${driftList}</div>`;
}



// ğŸ’¡ æœ€çµ‚å‡ºåŠ›
hits.push(`
  <h3>#${hits.length + 1}</h3>
  <p class="equip">${text}</p>
  <div class="hr"></div>
  <ul class="sumAll">${skills}</ul>
  ${driftText}
`);



  // ===== ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ï¼ˆã‚¹ã‚­ãƒ«ä¸€è‡´ãƒ»Lvä¸€è‡´ã‚’æœ€å„ªå…ˆï¼‰ =====
const scoredHits = hits.map(html => {
  const lvMap = {};
  const matches = [...html.matchAll(/([^<>\s]+) Lv(\d+)/g)];
  for (const m of matches) {
    const name = m[1], lv = parseInt(m[2]);
    lvMap[name] = (lvMap[name] || 0) + lv;
  }

  // æ¡ä»¶ã‚¹ã‚­ãƒ«å–å¾—
  const conds = [];
  for (let i = 0; i < 8; i++) {
    const s = (document.getElementById(`s_${i}`)?.value || "").trim();
    const lv = parseInt(document.getElementById(`lv_${i}`)?.value || "", 10);
    if (s && !isNaN(lv) && lv > 0) conds.push({ skill: s, level: lv });
  }
  if (rockOnEnabled && !conds.some(c => c.skill === "ãƒ­ãƒƒã‚¯ã‚ªãƒ³"))
    conds.push({ skill: "ãƒ­ãƒƒã‚¯ã‚ªãƒ³", level: 1 });

  let score = 0;

  // ğŸŸ¡ æ¡ä»¶ã‚¹ã‚­ãƒ«ä¸€è‡´ã®å„ªå…ˆåº¦ã‚’å¤§å¹…ã‚¢ãƒƒãƒ—
  for (const c of conds) {
    const got = lvMap[c.skill] || 0;
    if (got === 0) {
      score -= 1000; // è©²å½“ã‚¹ã‚­ãƒ«ãªã—ã¯å¼·ãæ¸›ç‚¹
    } else if (got === c.level) {
      score += 2000; // Lvä¸€è‡´ã¯æœ€ä¸Šä½åŠ ç‚¹ï¼
    } else if (got > c.level) {
      score += 1500 - (got - c.level) * 100; // å°‘ã—è¶…éãªã‚‰å°‘ã—æ¸›ç‚¹
    } else {
      score -= (c.level - got) * 300; // è¶³ã‚Šãªã„ã»ã©å¤§ããæ¸›ç‚¹
    }
  }

  // ğŸŸ¢ æ¡ä»¶ã‚¹ã‚­ãƒ«ãŒã™ã¹ã¦æƒã£ã¦ã„ãªã„å ´åˆã¯å¼·åˆ¶æ¸›ç‚¹
  const missing = conds.filter(c => (lvMap[c.skill] || 0) === 0).length;
  if (missing > 0) score -= 2000 * missing;

  // ğŸŸ£ æ¡ä»¶å¤–ã‚¹ã‚­ãƒ«ã¯è»½ãè£œåŠ©ç‚¹
  const otherSkills = Object.keys(lvMap).filter(n => !conds.some(c => c.skill === n));
  score += otherSkills.length * 5;

  // ğŸ’  ç©ºãæ ãƒœãƒ¼ãƒŠã‚¹ã¯æ§ãˆã‚ã«ï¼ˆå½±éŸ¿ã‚’å°ã•ãï¼‰
  const partsUsed = (html.match(/ï¼š[^<>\n]+/g) || []).filter(t => !/ï¼š\s*<\/?/.test(t)).length;
  score += (5 - partsUsed) * 50;

  return { html, score };
});


  scoredHits.sort((a, b) => b.score - a.score);
  const topHits = scoredHits.slice(0, 50);

  if (topHits.length === 0)
    resultsBox.innerHTML = cardHTML("çµæœ 0ä»¶", "æ¡ä»¶ã«åˆã†è£…å‚™ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
  else
    topHits.forEach(x => {
      const div = document.createElement("div");
      div.className = "card";
      div.innerHTML = x.html;
      resultsBox.appendChild(div);
    });

  const msg = `æ¢ç´¢å®Œäº†ï¼š${checked.toLocaleString()}ä»¶ï¼ˆãƒ’ãƒƒãƒˆ ${hits.length}ä»¶ï¼‰`;
  progressEl.textContent = msg;
  floatEl.textContent = msg;
}

/* ====== ä¸€è¦§ã‚¿ãƒ–ï¼šæ§‹ç¯‰ï¼†ãƒ•ã‚£ãƒ«ã‚¿ ====== */
function buildListTable(){
  const body = document.getElementById('listBody');
  const countEl = document.getElementById('listCount');
  const fltPart = document.getElementById('flt-part');
  const fltSkill = document.getElementById('flt-skill');

  function render(){
    const kw = (fltSkill.value||"").trim();
    const part = fltPart.value||"";
    const rx = kw ? new RegExp(escapeRegExp(kw), 'i') : null;

    const list = armors.filter(a=>{
      if(part && a.part!==part) return false;
      if(listDriftOnly){
        if(rx){ return a.drift.length>0 && rx.test(a.drift.join(", ")); }
        else{ return a.drift.length>0; }
      }else{
        if(!rx) return true;
        const normalStr = a.normal.map(s=>`${s.name}Lv${s.lv}`).join(", ");
        const driftStr  = a.drift.join(", ");
        return rx.test(a.name) || rx.test(a.monster||"") || rx.test(normalStr) || rx.test(driftStr);
      }
    });

    body.innerHTML = list.map(a=>{
      const normalStr = a.normal.map(s=>`${escapeHTML(s.name)}Lv${s.lv}`).join(", ");
      const driftStr  = a.drift.length ? a.drift.map(escapeHTML).join(", ") : "â€”";
      return `<tr>
        <td data-label="éƒ¨ä½">${escapeHTML(a.part)}</td>
        <td data-label="ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼">${escapeHTML(a.monster||"")}</td>
        <td data-label="é˜²å…·å">${escapeHTML(a.name)}</td>
        <td data-label="é€šå¸¸ã‚¹ã‚­ãƒ«" class="td-skills">${normalStr||"â€”"}</td>
        <td data-label="éŒ¬æˆã‚¹ã‚­ãƒ«" class="td-skills">${driftStr}</td>
      </tr>`;
    }).join("");

    countEl.textContent = `${list.length} ä»¶è¡¨ç¤ºï¼ˆç·è¨ˆ ${armors.length}ï¼‰` + (listDriftOnly ? "ï¼ˆéŒ¬æˆã®ã¿ï¼‰" : "");
  }
  fltPart.addEventListener('change', render);
  fltSkill.addEventListener('input', render);
  render();
}

/* ====== éŒ¬æˆCSVä½œæˆï¼šè¡Œç”Ÿæˆï¼å‰Šé™¤ ====== */
const makerBody = document.getElementById('makerBody');
document.getElementById('makerAdd').addEventListener('click', ()=> addMakerRow());

function addMakerRow(data = null){
  const tr = document.createElement('tr');

  const tdPart = document.createElement('td');
  const sel = document.createElement('select');
  PARTS.forEach(p=>{ const o=document.createElement('option'); o.value=o.textContent=p; sel.appendChild(o); });
  tdPart.appendChild(sel);

  const tdMon = document.createElement('td');
  const inMon = document.createElement('input'); inMon.placeholder="ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼åç§°";
  tdMon.appendChild(inMon);

  const tdName = document.createElement('td');
  const inName = document.createElement('input'); inName.placeholder="é˜²å…·åç§°";
  tdName.appendChild(inName);

  const driftInputs = [];
  for(let i=0;i<5;i++){
    const td = document.createElement('td');
    const inp = document.createElement('input');
    inp.setAttribute('list','skills'); // ã‚¹ã‚­ãƒ«å€™è£œã‚’æµç”¨
    inp.placeholder = `éŒ¬æˆ${i+1}`;
    td.appendChild(inp);
    tr.appendChild(td);
    driftInputs.push(inp);
  }

  const tdOps = document.createElement('td');
  const del = document.createElement('button'); del.textContent="å‰Šé™¤"; del.className='btnDanger';
  del.addEventListener('click', ()=> tr.remove());
  tdOps.appendChild(del);

  tr.appendChild(tdPart); tr.appendChild(tdMon); tr.appendChild(tdName);
  // drift tds ã¯ä¸Šã§è¿½åŠ æ¸ˆã¿
  tr.appendChild(tdOps);

  makerBody.appendChild(tr);

  // æ—¢å®šå€¤
  if(data){
    sel.value = data.part || PARTS[0];
    inMon.value = data.monster || "";
    inName.value = data.name || "";
    (data.drift||[]).slice(0,5).forEach((v,i)=>{ driftInputs[i].value = v; });
  }
}

/* ====== CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆéŒ¬æˆCSVä½œæˆã‚¿ãƒ–ï¼‰ ====== */
document.getElementById('makerDownload').addEventListener('click', ()=>{
  const rows = collectMakerRows();
  const header = ['éƒ¨ä½','ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼åç§°','é˜²å…·åç§°','ã‚¹ã‚­ãƒ«1','ã‚¹ã‚­ãƒ«1Lv','ã‚¹ã‚­ãƒ«2','ã‚¹ã‚­ãƒ«2Lv','ã‚¹ã‚­ãƒ«3','ã‚¹ã‚­ãƒ«3Lv','éŒ¬æˆ1','éŒ¬æˆ2','éŒ¬æˆ3','éŒ¬æˆ4','éŒ¬æˆ5','éŒ¬æˆ6','éŒ¬æˆ7','éŒ¬æˆ8','éŒ¬æˆ9','éŒ¬æˆ10'];
  const csvLines = [ header.join(',') ];

  rows.forEach(r=>{
    const drifts = [...r.drift]; while(drifts.length<10) drifts.push('');
    const line = [
      r.part, r.monster, r.name,
      '', '', '', '', '', '', // é€šå¸¸ã‚¹ã‚­ãƒ«ã¯ç©ºæ¬„
      ...drifts
    ].map(csvEscape).join(',');
    csvLines.push(line);
  });

  const blob = new Blob([csvLines.join('\n')], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'custom_drift.csv';
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
  statusEl.textContent = "éŒ¬æˆCSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã‚ˆï¼";
});

function collectMakerRows(){
  const out=[];
  [...makerBody.querySelectorAll('tr')].forEach(tr=>{
    const part = tr.querySelector('select')?.value || PARTS[0];
    const tds = tr.querySelectorAll('td');
    const monster = tds[1].querySelector('input')?.value?.trim() || "";
    const name    = tds[2].querySelector('input')?.value?.trim() || "";
    if(!name) return; // é˜²å…·åå¿…é ˆ
    const drift=[];
    // drift inputs ã¯ tds[3]..tds[7]
    for(let i=3;i<=7;i++){
      const v = tds[i].querySelector('input')?.value?.trim();
      if(v) drift.push(v);
    }
    out.push({part, monster, name, drift});
  });
  return out;
}
function csvEscape(s){
  const t = String(s??'');
  return (t.includes(',') || t.includes('"') || t.includes('\n')) ? `"${t.replace(/"/g,'""')}"` : t;
}

/* ====== ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã¸åæ˜ ï¼ˆéŒ¬æˆCSVä½œæˆã‚¿ãƒ–ï¼‰ ====== */
document.getElementById('makerApply').addEventListener('click', ()=>{
  const rows = collectMakerRows();
  // æ—¢å­˜armorsã¸ãƒãƒ¼ã‚¸ã€‚ãªã‘ã‚Œã°ä½œæˆã€‚
  for(const r of rows){
    let a = armors.find(x => x.part===r.part && x.name===r.name && (x.monster||"")=== (r.monster||""));
    if(!a){
      a = {part:r.part, monster:r.monster||"", name:r.name, normal:[], drift:[]};
      armors.push(a);
    }
    const set = new Set(a.drift);
    r.drift.forEach(d => { if(d){ set.add(d); skillSet.add(d); } });
    a.drift = [...set];
  }
  buildListTable();
  buildSkillInputs([...skillSet].sort());
  statusEl.textContent = "éŒ¬æˆå†…å®¹ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã«åæ˜ ã—ãŸã‚ˆï¼";
  // ã™ãæ¤œç´¢ã—ãŸã„æ™‚ã®ãŸã‚ã€ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ã‚¿ãƒ–ã¸
  showTab('sim');
});

/* ====== å–ã‚Šè¾¼ã‚“ã CSVã®éŒ¬æˆ â†’ ãƒ¡ãƒ¼ã‚«ãƒ¼ã«åæ˜  ====== */
function populateMakerFromArmors(){
  makerBody.innerHTML = "";
  // ãƒ‰ãƒªãƒ•ãƒˆã‚ã‚Šã®ã‚‚ã®ã‚’è¡ŒåŒ–ï¼ˆ5å€‹è¶…ã¯è¤‡æ•°è¡Œã«åˆ†å‰²ï¼‰
  for(const a of armors){
    if(!a.drift || a.drift.length===0) continue;
    for(let i=0;i<a.drift.length; i+=5){
      addMakerRow({
        part:a.part, monster:a.monster||"", name:a.name,
        drift:a.drift.slice(i, i+5)
      });
    }
  }
  if(makerBody.children.length===0) addMakerRow(); // 0ä»¶ãªã‚‰ç©ºè¡Œ
}

/* ====== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ====== */
function cardHTML(title, body){
  return `<div class="card"><h3>${escapeHTML(title)}</h3><div class="hr"></div><div class="equip">${escapeHTML(body)}</div></div>`;
}
function escapeHTML(s){
  return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
}
function escapeRegExp(s){ return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }

/* ===== ã‚¹ãƒãƒ›æ™‚ã¯çµæœã‚’æ¤œç´¢ãƒœã‚¿ãƒ³ã®ä¸‹ã«ç§»å‹• ===== */
function adjustLayoutForMobile() {
  const resultsSim = document.getElementById("resultsSim");
  const panelSim = document.getElementById("panel-sim");
  if (window.innerWidth <= 640) {
    if (!panelSim.contains(resultsSim)) {
      panelSim.appendChild(resultsSim);
      resultsSim.style.display = "block";
    }
  } else {
    const right = document.querySelector(".right");
    if (!right.contains(resultsSim)) {
      right.prepend(resultsSim);
      resultsSim.style.display = "grid";
    }
  }
}
window.addEventListener("resize", adjustLayoutForMobile);

/* ====== ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«CSVã‚’è‡ªå‹•èª­è¾¼ï¼ˆä»»æ„ã®åŒéšå±¤CSVåã«å¤‰æ›´OKï¼‰ ====== */
window.addEventListener('DOMContentLoaded', () => {
  showTab('sim'); // åˆæœŸã¯ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼
  adjustLayoutForMobile();
  // ç½®ã„ã¦ã‚ã‚‹åˆæœŸCSVã‚’èª­ã¿è¾¼ã‚€å ´åˆã¯æœ‰åŠ¹åŒ–ã—ã¦ã­
  fetch('ã‚¹ã‚­ãƒ«ä¸€è¦§.csv')
  .then(res => res.text())
  .then(text => {
    parseCSV(text);
    statusEl.textContent = `åˆæœŸãƒ‡ãƒ¼ã‚¿èª­è¾¼å®Œäº†ï¼š${armors.length}ä»¶ï¼ˆã‚¹ã‚­ãƒ«å€™è£œ ${skillSet.size}ï¼‰`;
    populateMakerFromArmors();
  })
  .catch(err => {
    console.error('åˆæœŸCSVèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', err);
    statusEl.textContent = "åˆæœŸCSVèª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
    addMakerRow();
  });
  // åˆæœŸã¯ç©ºã®ãƒ¡ãƒ¼ã‚«ãƒ¼ã«1è¡Œã ã‘
  addMakerRow();
});
</script>
</body>
</html>









