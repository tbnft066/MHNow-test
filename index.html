<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>モンハンNow スキルシュミレーター</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --bg:#0d0d0d; --panel:#171717; --card:#1f1f1f;
    --text:#ffffff; --muted:#bfbfbf; --accent:#ffd45e; --accent2:#ffb347; --border:#2a2a2a;
    --hilite:#ffe27a; --skill:#e6e6e6; --drift:#a7dcff;
    --green:#2ecc71; --purple:#bb86fc; --off:#555; --blue:#4da3ff;
  }
  *{box-sizing:border-box}
  body{
    margin:0; background:var(--bg); color:var(--text);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;
    height:100vh; display:grid; grid-template-columns:460px 1fr;
  }
  .left{background:var(--panel); border-right:1px solid var(--border); padding:18px; overflow:auto;}
  .title{color:var(--accent); font-size:20px; font-weight:700; margin-bottom:12px}
  .tabs{display:flex; gap:8px; margin-bottom:14px; flex-wrap:wrap}
  .tab{padding:8px 12px; border:1px solid var(--border); border-radius:10px; background:#101010; color:#ddd; cursor:pointer; font-weight:700; font-size:14px;}
  .tab.active{background:var(--accent); color:#111; border-color:#cdbf65}
  .group{margin-bottom:16px}
  label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
  input, select, button{width:100%; border:1px solid var(--border); background:#101010; color:#fff; border-radius:8px; padding:9px 10px; font-size:14px;}
  input:disabled{opacity:.55; cursor:not-allowed}
  button{background:var(--accent); color:#111; border:none; font-weight:700; cursor:pointer}
  button:hover{filter:brightness(1.05)}
  .rows{display:grid; grid-template-columns:1fr 84px; gap:8px}
  .status{font-size:12px; color:var(--muted); white-space:pre-line; margin-top:6px}
  .toggles{display:flex; align-items:center; gap:16px; margin-bottom:10px;}
  .toggle-block{display:flex; align-items:center; gap:8px;}
  .dot{width:42px; height:22px; border-radius:999px; background:var(--off); border:2px solid var(--border); position:relative; cursor:pointer; transition:background .25s, border-color .25s;}
  .dot::before{content:""; position:absolute; top:2px; left:2px; width:16px; height:16px; background:#ccc; border-radius:50%; transition:left .25s, background .25s;}
  .dot.green.on{background:var(--green); border-color:var(--green)}
  .dot.green.on::before{left:22px; background:#fff}
  .dot.purple.on{background:var(--purple); border-color:var(--purple)}
  .dot.purple.on::before{left:22px; background:#fff}
  .dot.blue.on{background:var(--blue); border-color:var(--blue)}
  .dot.blue.on::before{left:22px; background:#fff}
  .dot.off{background:var(--off); border-color:var(--border)}
  .dot.off::before{left:2px; background:#888}
  .hint{font-size:12px; color:var(--muted); margin-top:2px}
  .right{padding:18px; overflow:auto}
  .grid{display:grid; grid-template-columns:repeat(auto-fill, minmax(420px,1fr)); gap:16px}
  .card{background:var(--card); border:1px solid var(--border); border-radius:12px; padding:12px 14px; box-shadow:0 0 10px rgba(0,0,0,0.35);}
  .card h3{margin:0 0 8px 0; color:var(--accent2); font-size:16px}
  .equip{white-space:pre-wrap; line-height:1.5; color:#eaeaea; margin:0 0 8px 0}
  .hr{height:1px; background:var(--border); margin:8px 0}
  .sumAll{display:flex; flex-wrap:wrap; gap:8px 12px; margin:0; padding:0}
  .badge{list-style:none; border:1px solid var(--border); border-radius:999px; padding:2px 8px; font-size:12px; color:var(--skill); background:#141414; white-space:nowrap;}
  .badge.hilite{color:#111; background:var(--hilite); border-color:#cdbf65}
  .drifts{color:var(--drift); font-size:12px; margin-top:6px}
  .progressFloating{position:fixed; top:12px; right:16px; background:#000a; backdrop-filter:blur(4px); border:1px solid var(--border); border-radius:10px; padding:8px 12px; font-size:12px; color:var(--muted); z-index:9999; pointer-events:none;}
  .list-controls{display:flex; gap:8px; position:sticky; top:0; background:var(--panel); padding-bottom:8px; z-index:2; align-items:center}
  .tableWrap{border:1px solid var(--border); border-radius:12px; overflow:auto; max-height:calc(100vh - 120px)}
  table{width:100%; border-collapse:collapse; font-size:13px}
  thead{background:#141414; z-index:1}
  th, td{border-bottom:1px solid var(--border); padding:8px 10px; vertical-align:top}
  th{color:#ddd; text-align:left}
  td{color:#eee}
  .sticky-header thead th{position:sticky; top:0; background:#141414;}
  .maker-ops{display:flex; gap:8px; flex-wrap:wrap}
  .maker-note{color:var(--muted); font-size:12px; margin-top:6px}
  .makerWrap{border:1px solid var(--border); border-radius:12px; overflow:auto; max-height:calc(100vh - 200px)}
  .makerTable input, .makerTable select{width:100%; padding:6px 8px; font-size:13px}
  .btnDanger{background:#e45858; color:#fff}
  @media (max-width: 640px) {
    body{grid-template-columns:1fr; height:auto}
    .right{order:3}
    .tableWrap{border:none; overflow:visible; max-height:none}
    table.sticky-header, table.sticky-header thead, table.sticky-header tbody, table.sticky-header th, table.sticky-header td, table.sticky-header tr{display:block; width:100%;}
    table.sticky-header thead{display:none}
    table.sticky-header tr{margin-bottom:14px; border:1px solid var(--border); border-radius:10px; background:var(--card); box-shadow:0 0 8px rgba(0,0,0,0.25); padding:10px;}
    table.sticky-header td{border:none; padding:4px 0; font-size:13px; display:flex; justify-content:space-between; gap:8px;}
    table.sticky-header td::before{content:attr(data-label); color:var(--muted); font-weight:bold}
    .makerWrap{max-height:none; border:none}
  }
</style>
</head>
<body>
  <aside class="left">
    <div class="title">モンハンNow スキルシュミレーター</div>
    <div class="tabs">
      <button class="tab active" id="tab-sim">スキルシミュレーター</button>
      <button class="tab" id="tab-list">防具スキル一覧</button>
      <button class="tab" id="tab-maker">錬成CSV作成</button>
    </div>
    <div class="group">
      <label>CSVを読み込む（ヘッダー必須 / UTF-8）</label>
      <input type="file" id="csv" accept=".csv" />
      <div id="status" class="status">未読込</div>
    </div>
    <div class="group" id="panel-sim">
      <div class="toggles">
        <div class="toggle-block">
          <div class="dot green off" id="toggleRock"></div><span class="hint">ロックオン</span>
        </div>
        <div class="toggle-block">
          <div class="dot purple off" id="toggleDrift"></div><span class="hint">漂移錬成</span>
        </div>
      </div>
      <label>スキル条件（最大8個） ※Lv1〜5／Lv空欄は条件から除外</label>
      <div class="rows" id="rows"></div>
      <div class="group" style="margin-top:10px">
        <button id="search">検索</button>
        <button id="reset" style="margin-top:6px; background:#555; color:#fff;">リセット</button>
        <div id="progress" class="status"></div>
      </div>
    </div>
    <div id="panel-list" style="display:none;">
      <div class="group">
        <label>フィルター</label>
        <div class="list-controls">
          <select id="flt-part"><option value="">部位：すべて</option><option>頭</option><option>胴</option><option>腕</option><option>腰</option><option>脚</option></select>
          <input id="flt-skill" placeholder="スキル名で検索（部分一致／通常・錬成）" />
        </div>
        <div class="toggle-block" style="margin-top:10px;">
          <div class="dot blue off" id="toggleListDrift"></div><span class="hint">錬成のみ</span>
        </div>
      </div>
    </div>
  </aside>

  <main class="right">
    <div id="resultsSim" class="grid"></div>
    <div id="resultsList" style="display:none;">
      <div class="tableWrap">
        <table id="armorTable" class="sticky-header">
          <thead><tr><th>部位</th><th>モンスター</th><th>防具名</th><th>通常スキル</th><th>錬成スキル</th></tr></thead>
          <tbody id="listBody"></tbody>
        </table>
      </div>
      <div class="muted" id="listCount" style="margin-top:6px;"></div>
    </div>
    <div id="panel-maker" style="display:none;">
      <div class="maker-ops" style="margin-bottom:10px;">
        <button id="makerAdd">＋行追加</button>
        <button id="makerDownload">CSVをダウンロード</button>
        <button id="makerApply">シミュレーターへ反映</button>
      </div>
      <div class="maker-note">※「錬成スキル」は1行あたり最大5つ。空欄は無視されるよ。</div>
      <div class="makerWrap" style="margin-top:10px;">
        <table class="makerTable sticky-header" id="makerTable">
          <thead><tr><th>部位</th><th>モンスター</th><th>防具名</th><th>錬成1</th><th>錬成2</th><th>錬成3</th><th>錬成4</th><th>錬成5</th><th>操作</th></tr></thead>
          <tbody id="makerBody"></tbody>
        </table>
      </div>
    </div>
  </main>

  <div id="progressFloating" class="progressFloating" style="display:none;">探索待機中…</div>

<script>
/* ====== データ構造 ====== */
const PARTS = ["頭","胴","腕","腰","脚"];
let armors = [];
let skillSet = new Set();
let rockOnEnabled = false;
let driftEnabled  = false;
let listDriftOnly = false;

/* ====== 要素参照 ====== */
let statusEl, resultsSim, resultsList, panelSim, panelList, panelMaker;
let tabSim, tabList, tabMaker, makerBody;

/* ====== タブ切替 ====== */
function showTab(which){
  [tabSim, tabList, tabMaker].forEach(b=>b.classList.remove('active'));
  if(which==='sim') tabSim.classList.add('active');
  if(which==='list') tabList.classList.add('active');
  if(which==='maker') tabMaker.classList.add('active');
  panelSim.style.display = (which==='sim')?'block':'none';
  panelList.style.display = (which==='list')?'block':'none';
  panelMaker.style.display= (which==='maker')?'block':'none';
  resultsSim.style.display  = (which==='sim')?'grid':'none';
  resultsList.style.display = (which==='list')?'block':'none';
  adjustLayoutForMobile();
}

/* ====== 一覧タブ構築 ====== */
function buildListTable(){
  const body = document.getElementById('listBody');
  const countEl = document.getElementById('listCount');
  const fltPart = document.getElementById('flt-part');
  const fltSkill = document.getElementById('flt-skill');
  function render(){
    const kw = (fltSkill.value||"").trim();
    const part = fltPart.value||"";
    const rx = kw ? new RegExp(escapeRegExp(kw), 'i') : null;
    const list = armors.filter(a=>{
      if(part && a.part!==part) return false;
      if(listDriftOnly){
        if(rx){ return a.drift.length>0 && rx.test(a.drift.join(", ")); }
        else{ return a.drift.length>0; }
      }else{
        if(!rx) return true;
        const normalStr = a.normal.map(s=>`${s.name}Lv${s.lv}`).join(", ");
        const driftStr  = a.drift.join(", ");
        return rx.test(a.name) || rx.test(a.monster||"") || rx.test(normalStr) || rx.test(driftStr);
      }
    });
    body.innerHTML = list.map(a=>{
      const normalStr = a.normal.map(s=>`${escapeHTML(s.name)}Lv${s.lv}`).join(", ");
      const driftStr  = a.drift.length ? a.drift.map(escapeHTML).join(", ") : "—";
      return `<tr>
        <td>${escapeHTML(a.part)}</td>
        <td>${escapeHTML(a.monster||"")}</td>
        <td>${escapeHTML(a.name)}</td>
        <td>${normalStr||"—"}</td>
        <td>${driftStr}</td>
      </tr>`;
    }).join("");
    countEl.textContent = `${list.length} 件表示（総計 ${armors.length}）`;
  }
  fltPart.addEventListener('change', render);
  fltSkill.addEventListener('input', render);
  render();
}

  /* ====== スキル検索枠（8枠まで自動生成） ====== */
function buildSkillInputs(skillList){
  const rows = document.getElementById('rows');
  rows.innerHTML = "";
  const dlId="skills";
  let old = document.getElementById(dlId);
  if(old) old.remove();
  const dl = document.createElement('datalist');
  dl.id = dlId;
  skillList.forEach(s=>{
    const o=document.createElement('option');
    o.value=s;
    dl.appendChild(o);
  });
  document.body.appendChild(dl);

  for(let i=0;i<8;i++){
    const name=document.createElement('input');
    name.type="text";
    name.placeholder="スキル名";
    name.setAttribute("list",dlId);
    name.id=`s_${i}`;
    const lv=document.createElement('input');
    lv.type="number";
    lv.min="1";
    lv.max="5";
    lv.placeholder="Lv";
    lv.id=`lv_${i}`;
    lv.disabled=true;

    const syncDisable=()=>{
      const has=(name.value||"").trim().length>0;
      lv.disabled=!has;
      if(!has) lv.value="";
    };
    name.addEventListener('input',syncDisable);
    name.addEventListener('change',syncDisable);

    rows.appendChild(name);
    rows.appendChild(lv);
  }

  // ボタン再登録（古いイベントを避ける）
  const newBtn=document.getElementById('search').cloneNode(true);
  document.getElementById('search').replaceWith(newBtn);
  newBtn.id='search';
  newBtn.addEventListener('click', runSearch);
}


/* ====== 錬成CSV作成 ====== */
function addMakerRow(data=null){
  const tr = document.createElement('tr');
  const tdPart = document.createElement('td');
  const sel = document.createElement('select');
  PARTS.forEach(p=>{ const o=document.createElement('option'); o.value=o.textContent=p; sel.appendChild(o); });
  tdPart.appendChild(sel);
  const tdMon = document.createElement('td'); const inMon=document.createElement('input'); tdMon.appendChild(inMon);
  const tdName = document.createElement('td'); const inName=document.createElement('input'); tdName.appendChild(inName);
  tr.append(tdPart,tdMon,tdName);
  const driftInputs=[];
  for(let i=0;i<5;i++){
    const td=document.createElement('td'); const inp=document.createElement('input');
    inp.placeholder=`錬成${i+1}`; td.appendChild(inp); tr.appendChild(td); driftInputs.push(inp);
  }
  const tdOps=document.createElement('td'); const del=document.createElement('button');
  del.textContent="削除"; del.className='btnDanger'; del.onclick=()=>tr.remove();
  tdOps.appendChild(del); tr.appendChild(tdOps);
  makerBody.appendChild(tr);
  if(data){
    sel.value=data.part||PARTS[0]; inMon.value=data.monster||""; inName.value=data.name||"";
    (data.drift||[]).slice(0,5).forEach((v,i)=>{ driftInputs[i].value=v; });
  }
}

/* ====== 取り込み反映 ====== */
function populateMakerFromArmors(){
  makerBody.innerHTML="";
  for(const a of armors){
    if(!a.drift?.length) continue;
    for(let i=0;i<a.drift.length;i+=5){
      addMakerRow({part:a.part,monster:a.monster,name:a.name,drift:a.drift.slice(i,i+5)});
    }
  }
  if(makerBody.children.length===0) addMakerRow();
}

/* ====== ユーティリティ ====== */
function escapeHTML(s){return String(s).replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m]));}
function escapeRegExp(s){return s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');}
function adjustLayoutForMobile(){
  const resultsSim=document.getElementById("resultsSim");
  const panelSim=document.getElementById("panel-sim");
  if(window.innerWidth<=640){
    if(!panelSim.contains(resultsSim)){panelSim.appendChild(resultsSim);resultsSim.style.display="block";}
  }else{
    const right=document.querySelector(".right");
    if(!right.contains(resultsSim)){right.prepend(resultsSim);resultsSim.style.display="grid";}
  }
}
window.addEventListener("resize",adjustLayoutForMobile);

/* ====== ページロード後初期化 ====== */
window.addEventListener('DOMContentLoaded',()=>{
  statusEl=document.getElementById('status');
  resultsSim=document.getElementById('resultsSim');
  resultsList=document.getElementById('resultsList');
  panelSim=document.getElementById('panel-sim');
  panelList=document.getElementById('panel-list');
  panelMaker=document.getElementById('panel-maker');
  tabSim=document.getElementById('tab-sim');
  tabList=document.getElementById('tab-list');
  tabMaker=document.getElementById('tab-maker');
  makerBody=document.getElementById('makerBody');

  tabSim.onclick=()=>showTab('sim');
  tabList.onclick=()=>showTab('list');
  tabMaker.onclick=()=>showTab('maker');

  showTab('sim');
  adjustLayoutForMobile();

  document.getElementById('makerAdd').onclick=()=>addMakerRow();

  /* ====== CSVの自動読み込み ====== */
  fetch('スキル一覧.csv')
    .then(res=>res.text())
    .then(text=>{
      parseCSV(text);
      buildSkillInputs([...skillSet].sort()); // ← ここが重要！
      statusEl.textContent=`初期データ読込完了：${armors.length}件`;
      populateMakerFromArmors();
    })
    .catch(err=>{
      console.error('初期CSV読み込みエラー:',err);
      statusEl.textContent="初期CSV読み込みに失敗しました。";
      addMakerRow();
    });
});

/* ====== CSV解析 ====== */
function parseCSV(text){
  const lines = text.replace(/\r\n/g,"\n").replace(/\r/g,"\n").split("\n").filter(Boolean);
  const rows = lines.map(line => splitCsvLine(line));
  armors = [];
  skillSet = new Set();

  // ヘッダーを除いた本体行を処理
  for(let i=1;i<rows.length;i++){
    const r = rows[i];
    if(r.length<3) continue;
    const part = r[0], monster = r[1], name = r[2];
    if(!part || !name) continue;

    const normal = [];
    for(let k=0;k<3;k++){
      const s  = r[3 + k*2];
      const lv = parseInt(r[4 + k*2],10);
      if(s && !isNaN(lv) && lv>0){
        normal.push({name:s, lv});
        skillSet.add(s);
      }
    }

    const drift = [];
    for(let j=0;j<10;j++){
      const ds = r[9 + j];
      if(ds){
        drift.push(ds);
        skillSet.add(ds);
      }
    }

    armors.push({part, monster, name, normal, drift});
  }

  buildSkillInputs([...skillSet].sort());
  buildListTable();
}

/* ====== CSV1行パース ====== */
function splitCsvLine(line){
  const out=[]; let cur=""; let inQ=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i];
    if(ch==='"'){
      if(inQ && line[i+1]==='"'){ cur+='"'; i++; }
      else inQ=!inQ;
    }else if(ch===',' && !inQ){
      out.push(cur.trim()); cur="";
    }else{
      cur+=ch;
    }
  }
  out.push(cur.trim());
  return out;
}
</script>
</body>
</html>






